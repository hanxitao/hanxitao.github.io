<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="pv-cache-enabled" content="false"><meta name="generator" content="Jekyll v4.3.2" /><meta property="og:title" content="手写Vue2.0源码（二）-模板编译原理" /><meta name="author" content="hanxitao" /><meta property="og:locale" content="en_US" /><meta name="description" content="正文" /><meta property="og:description" content="正文" /><link rel="canonical" href="https://hanxitao.github.io/posts/Vue%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" /><meta property="og:url" content="https://hanxitao.github.io/posts/Vue%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" /><meta property="og:site_name" content="Layman" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-11-20T09:10:00+08:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="手写Vue2.0源码（二）-模板编译原理" /><meta name="twitter:site" content="@twitter_username" /><meta name="twitter:creator" content="@hanxitao" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"hanxitao"},"dateModified":"2022-06-04T00:12:12+08:00","datePublished":"2021-11-20T09:10:00+08:00","description":"正文","headline":"手写Vue2.0源码（二）-模板编译原理","mainEntityOfPage":{"@type":"WebPage","@id":"https://hanxitao.github.io/posts/Vue%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"},"url":"https://hanxitao.github.io/posts/Vue%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/"}</script><title>手写Vue2.0源码（二）-模板编译原理 | Layman</title><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="icon" href="/assets/img/favicons/favicon.ico" type="image/x-icon"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon.png"><link rel="apple-touch-icon" href="/assets/img/favicons/apple-icon-precomposed.png"><link rel="apple-touch-icon" sizes="57x57" href="/assets/img/favicons/apple-icon-57x57.png"><link rel="apple-touch-icon" sizes="60x60" href="/assets/img/favicons/apple-icon-60x60.png"><link rel="apple-touch-icon" sizes="72x72" href="/assets/img/favicons/apple-icon-72x72.png"><link rel="apple-touch-icon" sizes="76x76" href="/assets/img/favicons/apple-icon-76x76.png"><link rel="apple-touch-icon" sizes="114x114" href="/assets/img/favicons/apple-icon-114x114.png"><link rel="apple-touch-icon" sizes="120x120" href="/assets/img/favicons/apple-icon-120x120.png"><link rel="apple-touch-icon" sizes="144x144" href="/assets/img/favicons/apple-icon-144x144.png"><link rel="apple-touch-icon" sizes="152x152" href="/assets/img/favicons/apple-icon-152x152.png"><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-icon-180x180.png"><link rel="icon" type="image/png" sizes="192x192" href="/assets/img/favicons/android-icon-192x192.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="96x96" href="/assets/img/favicons/favicon-96x96.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/manifest.json"><meta name='msapplication-config' content='/assets/img/favicons/browserconfig.xml'><meta name="msapplication-TileColor" content="#ffffff"><meta name="msapplication-TileImage" content="/assets/img/favicons/ms-icon-144x144.png"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="cdn.jsdelivr.net"><link rel="dns-prefetch" href="cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css" integrity="sha256-LA89z+k9fjgMKQ/kq4OO2Mrf8VltYml/VES+Rg0fh20=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css" integrity="sha256-+N4/V/SbAFiW1MPBCXnfnP9QSN3+Keu+NlB+0ev/YKQ=" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://cdn.jsdelivr.net/gh/cotes2020/chirpy-images/commons/avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Layman</a></div><div class="site-subtitle font-italic">Death is just another path, one that we all must take.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/hanxitao" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>手写Vue2.0源码（二）-模板编译原理</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>手写Vue2.0源码（二）-模板编译原理</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> hanxitao </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Nov 20, 2021, 9:10 AM +0800" prep="on" > Nov 20, 2021 <i class="unloaded">2021-11-20T09:10:00+08:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Jun 4, 2022, 12:12 AM +0800" prefix="Updated " > Jun 4, 2022 <i class="unloaded">2022-06-04T00:12:12+08:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2122 words">11 min</span></div></div><div class="post-content"><h2 id="正文">正文</h2><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="k">new</span> <span class="nc">Vue</span><span class="p">({</span>
    <span class="na">el</span><span class="p">:</span> <span class="dl">'</span><span class="s1">#app</span><span class="dl">'</span><span class="p">,</span>
    <span class="nf">data</span><span class="p">()</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="na">a</span><span class="p">:</span> <span class="mi">111</span>
        <span class="p">};</span>
    <span class="p">},</span>
    <span class="nf">render</span><span class="p">(</span><span class="nx">h</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nf">h</span><span class="p">(</span><span class="dl">'</span><span class="s1">div</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span> <span class="na">id</span><span class="p">:</span> <span class="dl">'</span><span class="s1">a</span><span class="dl">'</span> <span class="p">},</span> <span class="dl">'</span><span class="s1">hello</span><span class="dl">'</span><span class="p">)</span>
    <span class="p">},</span>
    <span class="na">template</span><span class="p">:</span> <span class="s2">`&lt;div id='a'&gt;hello&lt;/div&gt;`</span>
<span class="p">})</span>
</pre></table></code></div></div><p>按照官网给出的生命周期图，传入的options选项里可以手动配置template或者是render</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/img/vue/template.png" alt="" /></p><blockquote><p>注意一：平常开发中我们使用的是不带编译版本的Vue版本（runtime-only），直接在options传入template选项在开发环境会报错</p></blockquote><blockquote><p>这里传入的template选项不要和.vue文件里的&lt;template&gt;模板混淆了，vue单文件组件的template是需要vue-loader进行处理的</p></blockquote><p>我们传入的el或者template选项最后都会被解析成render函数，这样才能保持模板解析的一致性。</p><h2 id="1模板编译入口">1.模板编译入口</h2><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
</pre><td class="rouge-code"><pre><span class="c1">// src/init.js</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">initState</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./state</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">compileToFunctions</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./compiler/index</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">initMixin</span><span class="p">(</span><span class="nx">Vue</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_init</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">options</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span> <span class="o">=</span> <span class="nx">options</span><span class="p">;</span>
        <span class="nf">initState</span><span class="p">(</span><span class="nx">vm</span><span class="p">);</span>

        <span class="c1">// 如果有el属性，进行模板渲染</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">vm</span><span class="p">.</span><span class="nf">$mount</span><span class="p">(</span><span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="p">.</span><span class="nx">el</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">};</span>

    <span class="c1">// 这块代码在源码里的位置其实是放在entry-runtime-with-compiler.js里面的</span>
    <span class="c1">// 代表的是Vue源码里面包含了compile编译功能，这个和runtime-only版本要区分开</span>
    <span class="nx">Vue</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">$mount</span> <span class="o">=</span> <span class="nf">function </span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">vm</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">options</span> <span class="o">=</span> <span class="nx">vm</span><span class="p">.</span><span class="nx">$options</span><span class="p">;</span>
        <span class="nx">el</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nf">querySelector</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>

        <span class="c1">// 如果不存在render属性</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">render</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">template</span> <span class="o">=</span> <span class="nx">options</span><span class="p">.</span><span class="nx">template</span><span class="p">;</span>

            <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">template</span> <span class="o">&amp;&amp;</span> <span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
                <span class="nx">template</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">outerHTML</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="k">if </span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
                <span class="kd">const</span> <span class="nx">render</span> <span class="o">=</span> <span class="nf">compilerToFunctions</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">render</span> <span class="o">=</span> <span class="nx">render</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>$mount方法最终将处理好的template模板转成render函数。</p><h2 id="2模板转化核心方法compiletofunctions">2.模板转化核心方法compileToFunctions</h2><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre><span class="k">import</span> <span class="p">{</span> <span class="nx">parse</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./parse</span><span class="dl">'</span><span class="p">;</span>
<span class="k">import</span> <span class="p">{</span> <span class="nx">generate</span> <span class="p">}</span> <span class="k">from</span> <span class="dl">'</span><span class="s1">./codegen</span><span class="dl">'</span><span class="p">;</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">compileToFunctions</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 需要把html字符串变成render函数</span>
    <span class="c1">// 1.把html代码转成ast语法树</span>
    <span class="kd">let</span> <span class="nx">ast</span> <span class="o">=</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">template</span><span class="p">);</span>
    <span class="c1">// 2.优化静态节点</span>
    <span class="c1">// 不影响核心功能此处不实现</span>
    <span class="c1">// if (options.optimize !== false) {</span>
    <span class="c1">//     optimize(ast, options);</span>
    <span class="c1">// }</span>

    <span class="c1">// 3.通过ast重新生成代码</span>
    <span class="c1">// 最后生成的代码需要和render函数一样</span>
    <span class="c1">// 类似_c('div', {id:'app'}, _c('div', undefined, _v('hello'+_s(name)), _c('span', undefined, _v('world'))))</span>
    <span class="c1">// _c代表创建元素、_v代表创建文本、_s代表JSON.stringify--把对象解析成文本</span>
    <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nf">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">renderFn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Function</span><span class="p">(</span><span class="s2">`with(this){return </span><span class="p">${</span><span class="nx">code</span><span class="p">}</span><span class="s2">}`</span><span class="p">);</span>
    <span class="k">return</span> <span class="nx">renderFn</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>新建compiler文件夹，表示编译相关功能。导出核心compileToFunctions函数，主要有三个步骤：1、生成ast；2、优化静态节点；3、根据ast生成render函数</p><h2 id="3解析html并生成ast">3.解析html并生成ast</h2><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
</pre><td class="rouge-code"><pre><span class="c1">// src/compiler/parse.js</span>

<span class="kd">const</span> <span class="nx">ncname</span> <span class="o">=</span> <span class="dl">'</span><span class="s1">[a-zA-Z_][</span><span class="se">\\</span><span class="s1">-</span><span class="se">\\</span><span class="s1">.0-9_a-zA-Z]*</span><span class="dl">'</span><span class="p">;</span> <span class="c1">// 匹配标签名，如abc-123</span>
<span class="kd">const</span> <span class="nx">qnameCapture</span> <span class="o">=</span> <span class="s2">`((?:</span><span class="p">${</span><span class="nx">ncname</span><span class="p">}</span><span class="se">\\</span><span class="s2">:)?</span><span class="p">${</span><span class="nx">ncname</span><span class="p">}</span><span class="s2">)`</span><span class="p">;</span> <span class="c1">// 匹配特殊标签，如abc:234，前面的abc:可有可无</span>
<span class="kd">const</span> <span class="nx">startTagOpen</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegExp</span><span class="p">(</span><span class="s2">`^&lt;</span><span class="p">${</span><span class="nx">qnameCapture</span><span class="p">}</span><span class="s2">`</span><span class="p">);</span> <span class="c1">// 匹配开始标签，如&lt;abc-123</span>
<span class="kd">const</span> <span class="nx">startTagClose</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">\s</span><span class="sr">*</span><span class="se">(\/?)</span><span class="sr">&gt;/</span><span class="p">;</span> <span class="c1">//匹配结束标签 &gt;</span>
<span class="kd">const</span> <span class="nx">endTag</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">RegExp</span><span class="p">(</span><span class="s2">`^&lt;</span><span class="se">\\</span><span class="s2">/</span><span class="p">${</span><span class="nx">qnameCapture</span><span class="p">}</span><span class="s2">[^&gt;]*&gt;`</span><span class="p">);</span> <span class="c1">// 匹配标签结尾，如&lt;/abc-123&gt;</span>
<span class="kd">const</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="sr">/^</span><span class="se">\s</span><span class="sr">*</span><span class="se">([^\s</span><span class="sr">"'&lt;&gt;</span><span class="se">\/</span><span class="sr">=</span><span class="se">]</span><span class="sr">+</span><span class="se">)(?:\s</span><span class="sr">*</span><span class="se">(</span><span class="sr">=</span><span class="se">)\s</span><span class="sr">*</span><span class="se">(?:</span><span class="sr">"</span><span class="se">([^</span><span class="sr">"</span><span class="se">]</span><span class="sr">*</span><span class="se">)</span><span class="sr">"+|'</span><span class="se">([^</span><span class="sr">'</span><span class="se">]</span><span class="sr">*</span><span class="se">)</span><span class="sr">'+|</span><span class="se">([^\s</span><span class="sr">"'=&lt;&gt;`</span><span class="se">]</span><span class="sr">+</span><span class="se">)))?</span><span class="sr">/</span><span class="p">;</span> <span class="c1">// 匹配属性，如id="app"</span>

<span class="kd">let</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">currentParent</span><span class="p">;</span> <span class="c1">// 代表根节点和当前父节点</span>
<span class="c1">// 用栈结构来获取开始和结束标签</span>
<span class="kd">let</span> <span class="nx">stack</span> <span class="o">=</span> <span class="p">[];</span>
<span class="c1">// 标识元素和文本type</span>
<span class="kd">const</span> <span class="nx">ELEMENT_TYPE</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="kd">const</span> <span class="nx">TEXT_TYPE</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

<span class="c1">// 生成ast方法</span>
<span class="kd">function</span> <span class="nf">createASTElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="na">tag</span><span class="p">:</span> <span class="nx">tagName</span><span class="p">,</span>
        <span class="na">type</span><span class="p">:</span> <span class="nx">ELEMENT_TYPE</span><span class="p">,</span>
        <span class="na">children</span><span class="p">:</span> <span class="p">[],</span>
        <span class="nx">attrs</span><span class="p">,</span>
        <span class="na">parent</span><span class="p">:</span> <span class="kc">null</span>
    <span class="p">};</span>
<span class="p">}</span>

<span class="c1">// 对开始标签进行处理</span>
<span class="kd">function</span> <span class="nf">handleStartTag</span><span class="p">({</span> <span class="nx">tagName</span><span class="p">,</span> <span class="nx">attrs</span> <span class="p">})</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">element</span> <span class="o">=</span> <span class="nf">createASTElement</span><span class="p">(</span><span class="nx">tagName</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">);</span>

    <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">root</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">root</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="nx">currentParent</span> <span class="o">=</span> <span class="nx">element</span><span class="p">;</span>
    <span class="nx">stack</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">// 对结束标签进行处理</span>
<span class="kd">function</span> <span class="nf">handleEndTag</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// 栈结构</span>
    <span class="c1">// 比如&lt;div&gt;&lt;span&gt;&lt;/span&gt;&lt;/div&gt;，当遇到第一个结束标签&lt;/span&gt;时，会匹配到栈顶&lt;span&gt;元素对应的ast并取出</span>
    <span class="kd">let</span> <span class="nx">element</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">.</span><span class="nf">pop</span><span class="p">();</span>
    <span class="c1">// 当前父元素就是栈顶的上一个元素，在这里类似div</span>
    <span class="nx">currentParent</span> <span class="o">=</span> <span class="nx">stack</span><span class="p">[</span><span class="nx">stack</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

    <span class="c1">// 建立parent和children的关系</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">currentParent</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">element</span><span class="p">.</span><span class="nx">parent</span> <span class="o">=</span> <span class="nx">currentParent</span><span class="p">;</span>
        <span class="nx">currentParent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">element</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 对文本进行处理</span>
<span class="kd">function</span> <span class="nf">handleChars</span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">text</span> <span class="o">=</span> <span class="nx">text</span><span class="p">.</span><span class="nf">replace</span><span class="p">(</span><span class="sr">/</span><span class="se">\s</span><span class="sr">/g</span><span class="p">,</span> <span class="dl">''</span><span class="p">);</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">currentParent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nf">push</span><span class="p">({</span>
            <span class="na">type</span><span class="p">:</span> <span class="nx">TEXT_TYPE</span><span class="p">,</span>
            <span class="nx">text</span>
        <span class="p">})</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 解析标签生成ast核心</span>
<span class="k">export</span> <span class="kd">function</span> <span class="nf">parse</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nf">log</span><span class="p">(</span><span class="nx">html</span><span class="p">);</span>
    <span class="k">while</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 查找&lt;</span>
        <span class="kd">let</span> <span class="nx">textEnd</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">indexOf</span><span class="p">(</span><span class="dl">'</span><span class="s1">&lt;</span><span class="dl">'</span><span class="p">);</span>
        <span class="c1">// 如果&lt;在第一个，那么证明接下来就是一个标签，不管是开始还是结束标签</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">textEnd</span> <span class="o">===</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">startTagMatch</span> <span class="o">=</span> <span class="nf">parseStartTag</span><span class="p">();</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">startTagMatch</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 把解析好的标签名和属性解析生成ast</span>
                <span class="nf">handleStartTag</span><span class="p">(</span><span class="nx">startTagMatch</span><span class="p">);</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 匹配结束标签&lt;/</span>
            <span class="kd">const</span> <span class="nx">endTagMatch</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="nx">endTag</span><span class="p">);</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">endTagMatch</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">advance</span><span class="p">(</span><span class="nx">endTagMatch</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
                <span class="nf">handleEndTag</span><span class="p">();</span>
                <span class="k">continue</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>

        <span class="kd">let</span> <span class="nx">text</span><span class="p">;</span>
        <span class="c1">// 如hello&lt;div&gt;&lt;/div&gt;</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">textEnd</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">text</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nx">textEnd</span><span class="p">);</span>

            <span class="k">if </span><span class="p">(</span><span class="nx">text</span><span class="p">)</span> <span class="p">{</span>
                <span class="nf">advance</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">);</span>
                <span class="nf">handleChars</span><span class="p">(</span><span class="nx">text</span><span class="p">);</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// 匹配开始标签</span>
    <span class="kd">function</span> <span class="nf">parseStartTag</span><span class="p">()</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">start</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="nx">startTagOpen</span><span class="p">);</span>

        <span class="k">if </span><span class="p">(</span><span class="nx">start</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">const</span> <span class="nx">match</span> <span class="o">=</span> <span class="p">{</span>
                <span class="na">tagName</span><span class="p">:</span> <span class="nx">start</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                <span class="na">attrs</span><span class="p">:</span> <span class="p">[]</span>
            <span class="p">};</span>

            <span class="c1">// 匹配到了开始标签就截取掉</span>
            <span class="nf">advance</span><span class="p">(</span><span class="nx">start</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>

            <span class="c1">// 开始匹配属性</span>
            <span class="c1">// end代表结束符号&gt;</span>
            <span class="c1">// attr表示匹配的属性</span>
            <span class="kd">let</span> <span class="nx">end</span><span class="p">,</span> <span class="nx">attr</span><span class="p">;</span>
            <span class="k">while</span><span class="p">(</span>
                <span class="o">!</span><span class="p">(</span><span class="nx">end</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="nx">startTagClose</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
                <span class="p">(</span><span class="nx">attr</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">match</span><span class="p">(</span><span class="nx">attribute</span><span class="p">))</span>
            <span class="p">)</span> <span class="p">{</span>
                <span class="nf">advance</span><span class="p">(</span><span class="nx">attr</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">);</span>
                <span class="nx">attr</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="na">name</span><span class="p">:</span> <span class="nx">attr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="na">value</span><span class="p">:</span> <span class="nx">attr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="nx">attr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">||</span> <span class="nx">attr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="c1">//这里是因为正则捕获支持双引号、单引号和无引号的属性值</span>
                <span class="p">};</span>
                <span class="nx">match</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">attr</span><span class="p">);</span>
            <span class="p">}</span>

            <span class="k">if </span><span class="p">(</span><span class="nx">end</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 代表一个标签匹配到结束的&gt;了，代表开始标签解析完毕</span>
                <span class="nf">advance</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
                <span class="k">return</span> <span class="nx">match</span><span class="p">;</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nf">advance</span><span class="p">(</span><span class="nx">n</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">html</span> <span class="o">=</span> <span class="nx">html</span><span class="p">.</span><span class="nf">substring</span><span class="p">(</span><span class="nx">n</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="nx">root</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>利用正则匹配html字符串，遇到开始标签、结束标签和文本分别作对应的处理。解析完毕之后生成对应的ast并建立相应的父子关联，不断地advence截取剩余的字符串，直到html全部解析完毕。此处主要写了对于开始标签里面的属性的处理–parseStartTag</p><h2 id="4根据ast重新生成代码">4.根据ast重新生成代码</h2><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
</pre><td class="rouge-code"><pre><span class="c1">// src/compiler/codegen.js</span>

<span class="kd">const</span> <span class="nx">defaultTagRE</span> <span class="o">=</span> <span class="sr">/</span><span class="se">\{\{((?:</span><span class="sr">.|</span><span class="se">\r?\n)</span><span class="sr">+</span><span class="se">?)\}\}</span><span class="sr">/g</span><span class="p">;</span> <span class="c1">// 匹配花括号，捕获里面的内容</span>

<span class="kd">function</span> <span class="nf">gen</span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 判断节点类型</span>
    <span class="c1">// 主要包含处理文本核心</span>
    <span class="c1">// 源码这块包含了复杂的处理，如v-once、v-for、v-if、自定义指令、slot等</span>
    <span class="c1">// 这里只考虑普通文本和花括号中变量表达式的处理</span>

    <span class="c1">// 如果是元素类型</span>
    <span class="k">if </span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">type</span> <span class="o">===</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
        <span class="c1">// 递归创建</span>
        <span class="k">return</span> <span class="nf">generate</span><span class="p">(</span><span class="nx">node</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="c1">// 如果是文本节点</span>
        <span class="kd">let</span> <span class="nx">text</span> <span class="o">=</span> <span class="nx">node</span><span class="p">.</span><span class="nx">text</span><span class="p">;</span>
        <span class="c1">// 不存在花括号变量表达式</span>
        <span class="k">if </span><span class="p">(</span><span class="o">!</span><span class="nx">defaultTagRE</span><span class="p">.</span><span class="nf">test</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">return</span> <span class="s2">`_v(</span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">text</span><span class="p">)}</span><span class="s2">)`</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 正则是全局模式，每次需要重置正则的lastIndex属性，不然会引发匹配bug</span>
        <span class="kd">let</span> <span class="nx">lastIndex</span> <span class="o">=</span> <span class="p">(</span><span class="nx">defaultTagRE</span><span class="p">.</span><span class="nx">lastIndex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">);</span>
        <span class="kd">let</span> <span class="nx">tokens</span> <span class="o">=</span> <span class="p">[];</span>
        <span class="kd">let</span> <span class="nx">match</span><span class="p">,</span> <span class="nx">index</span><span class="p">;</span>

        <span class="k">while</span><span class="p">(</span>
            <span class="p">(</span><span class="nx">match</span> <span class="o">=</span> <span class="nx">defaultTagRE</span><span class="p">.</span><span class="nf">exec</span><span class="p">(</span><span class="nx">text</span><span class="p">))</span>
        <span class="p">)</span> <span class="p">{</span>
            <span class="c1">// index代表匹配到的位置</span>
            <span class="nx">index</span> <span class="o">=</span> <span class="nx">match</span><span class="p">.</span><span class="nx">index</span><span class="p">;</span>
            <span class="k">if </span><span class="p">(</span><span class="nx">index</span> <span class="o">&gt;</span> <span class="nx">lastIndex</span><span class="p">)</span> <span class="p">{</span>
                <span class="c1">// 匹配到的\{\{位置，在tokens里面放入普通文本</span>
                <span class="nx">tokens</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="nx">lastIndex</span><span class="p">,</span> <span class="nx">index</span><span class="p">)))</span>
            <span class="p">}</span>

            <span class="c1">// 放入捕获到的变量内容</span>
            <span class="nx">tokens</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="s2">`_s(</span><span class="p">${</span><span class="nx">match</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nf">trim</span><span class="p">()}</span><span class="s2">)`</span><span class="p">);</span>
            <span class="c1">// 匹配指针后移</span>
            <span class="nx">lastIndex</span> <span class="o">=</span> <span class="nx">index</span> <span class="o">+</span> <span class="nx">match</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">length</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="c1">// 如果匹配完了花括号，text里面还有剩余的普通文本，那么继续push</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">lastIndex</span> <span class="o">&lt;</span> <span class="nx">text</span><span class="p">.</span><span class="nx">length</span><span class="p">)</span> <span class="p">{</span>
            <span class="nx">tokens</span><span class="p">.</span><span class="nf">push</span><span class="p">(</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">text</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="nx">lastIndex</span><span class="p">)));</span>
        <span class="p">}</span>

        <span class="c1">// _v表示创建文本</span>
        <span class="k">return</span> <span class="s2">`_v(</span><span class="p">${</span><span class="nx">tokens</span><span class="p">.</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">+</span><span class="dl">'</span><span class="p">)}</span><span class="s2">)`</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="c1">// 处理attrs属性</span>
<span class="kd">function</span> <span class="nf">genProps</span><span class="p">(</span><span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">str</span> <span class="o">=</span> <span class="dl">''</span><span class="p">;</span>

    <span class="k">for </span><span class="p">(</span><span class="kd">let</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span> <span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">let</span> <span class="nx">attr</span> <span class="o">=</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>

        <span class="c1">// 对attrs属性里的style做特殊处理</span>
        <span class="k">if </span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">name</span> <span class="o">===</span> <span class="dl">'</span><span class="s1">style</span><span class="dl">'</span><span class="p">)</span> <span class="p">{</span>
            <span class="kd">let</span> <span class="nx">obj</span> <span class="o">=</span> <span class="p">{};</span>
            <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">;</span><span class="dl">'</span><span class="p">).</span><span class="nf">forEach</span><span class="p">(</span><span class="nx">item</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="p">[</span><span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">]</span> <span class="o">=</span> <span class="nx">item</span><span class="p">.</span><span class="nf">split</span><span class="p">(</span><span class="dl">'</span><span class="s1">:</span><span class="dl">'</span><span class="p">);</span>
                <span class="nx">obj</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span><span class="p">;</span>
            <span class="p">});</span>
            <span class="nx">attr</span><span class="p">.</span><span class="nx">value</span> <span class="o">=</span> <span class="nx">obj</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="nx">str</span> <span class="o">+=</span> <span class="s2">`</span><span class="p">${</span><span class="nx">attr</span><span class="p">.</span><span class="nx">name</span><span class="p">}</span><span class="s2">:</span><span class="p">${</span><span class="nx">JSON</span><span class="p">.</span><span class="nf">stringify</span><span class="p">(</span><span class="nx">attr</span><span class="p">.</span><span class="nx">value</span><span class="p">)}</span><span class="s2">,`</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="s2">`{</span><span class="p">${</span><span class="nx">str</span><span class="p">.</span><span class="nf">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)}</span><span class="s2">}`</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// 生成子节点，调用gen函数进行递归创建</span>
<span class="kd">function</span> <span class="nf">getChildren</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">children</span> <span class="o">=</span> <span class="nx">el</span><span class="p">.</span><span class="nx">children</span><span class="p">;</span>

    <span class="k">if </span><span class="p">(</span><span class="nx">children</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="s2">`</span><span class="p">${</span><span class="nx">children</span><span class="p">.</span><span class="nf">map</span><span class="p">(</span><span class="nx">c</span> <span class="o">=&gt;</span> <span class="nf">gen</span><span class="p">(</span><span class="nx">c</span><span class="p">)).</span><span class="nf">join</span><span class="p">(</span><span class="dl">'</span><span class="s1">,</span><span class="dl">'</span><span class="p">)}</span><span class="s2">`</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">export</span> <span class="kd">function</span> <span class="nf">generate</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">children</span> <span class="o">=</span> <span class="nf">getChildren</span><span class="p">(</span><span class="nx">el</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="s2">`_c('</span><span class="p">${</span><span class="nx">el</span><span class="p">.</span><span class="nx">tag</span><span class="p">}</span><span class="s2">', </span><span class="p">${</span>
        <span class="nx">el</span><span class="p">.</span><span class="nx">attrs</span><span class="p">.</span><span class="nx">length</span>
        <span class="p">?</span> <span class="s2">`</span><span class="p">${</span><span class="nf">genProps</span><span class="p">(</span><span class="nx">el</span><span class="p">.</span><span class="nx">attrs</span><span class="p">)}</span><span class="s2">`</span>
        <span class="p">:</span> <span class="dl">'</span><span class="s1">undefined</span><span class="dl">'</span>
    <span class="p">}${</span>
        <span class="nx">children</span>
        <span class="p">?</span> <span class="s2">`,</span><span class="p">${</span><span class="nx">children</span><span class="p">}</span><span class="s2">`</span>
        <span class="p">:</span> <span class="dl">''</span>
    <span class="p">}</span><span class="s2">)`</span><span class="p">;</span>

    <span class="k">return</span> <span class="nx">code</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>拿到生成好的ast之后，需要把ast转化成类似_c(‘div’,{id:”app”},_c(‘div’,undefined,_v(“hello”+_s(name)),_c(‘span’,undefined,_v(“world”))))这样的字符串</p><h2 id="5code字符串生成render函数">5.code字符串生成render函数</h2><div class="language-javascript highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="k">export</span> <span class="kd">function</span> <span class="nf">compileToFunctions</span><span class="p">(</span><span class="nx">template</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">let</span> <span class="nx">code</span> <span class="o">=</span> <span class="nf">generate</span><span class="p">(</span><span class="nx">ast</span><span class="p">);</span>
    <span class="kd">let</span> <span class="nx">renderFn</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Function</span><span class="p">(</span><span class="s2">`with(this){return </span><span class="p">${</span><span class="nx">code</span><span class="p">}</span><span class="s2">}`</span><span class="p">);</span>

    <span class="k">return</span> <span class="nx">renderFn</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/vue/'>Vue</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/vue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" class="post-tag no-text-decoration" >Vue源码分析</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=手写Vue2.0源码（二）-模板编译原理 - Layman&url=https://hanxitao.github.io/posts/Vue%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=手写Vue2.0源码（二）-模板编译原理 - Layman&u=https://hanxitao.github.io/posts/Vue%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=手写Vue2.0源码（二）-模板编译原理 - Layman&url=https://hanxitao.github.io/posts/Vue%E6%A8%A1%E6%9D%BF%E7%BC%96%E8%AF%91%E5%8E%9F%E7%90%86/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/Vue%E4%B9%8Bdiff%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86/">手写Vue2.0源码（六）-diff算法原理</a><li><a href="/posts/Vue%E8%AE%A1%E7%AE%97%E5%B1%9E%E6%80%A7%E5%8E%9F%E7%90%86/">手写Vue2.0源码（八）-计算属性原理</a><li><a href="/posts/Vue%E6%8C%87%E4%BB%A4%E4%B9%8B%E5%8E%BB%E9%99%A4input%E5%80%BC%E4%B8%AD%E9%97%B4%E7%A9%BA%E6%A0%BC/">Vue指令之去除input值中间空格</a><li><a href="/posts/debounce-and-throttle/">防抖节流</a><li><a href="/posts/Vue%E6%B8%B2%E6%9F%93%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/">手写Vue2.0源码（四）-渲染更新原理</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/css/">css</a> <a class="post-tag" href="/tags/everydaylearn/">EverydayLearn</a> <a class="post-tag" href="/tags/js%E7%9B%B8%E5%85%B3/">js相关</a> <a class="post-tag" href="/tags/vue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Vue源码分析</a> <a class="post-tag" href="/tags/leetcode/">LeetCode</a> <a class="post-tag" href="/tags/%E6%89%8B%E5%86%99/">手写</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/vue/">Vue</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/"><div class="card-body"> <span class="timeago small" > Nov 18, 2021 <i class="unloaded">2021-11-18T09:10:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>手写Vue2.0源码（一）-响应式数据原理</h3><div class="text-muted small"><p> 正文 Vue的一个核心特点是数据驱动。如果按照以往Jquery的思想，数据变化了想要同步到视图就必须要手动操作DOM更新，但是Vue帮我们做到了数据变动自动更新视图的功能，那在Vue内部就一定有一个机制能监听到数据变化然后触发更新。 1.数据初始化 new Vue({ el: '#app', router, store, render: h =&gt; h(App) }...</p></div></div></a></div><div class="card"> <a href="/posts/Vue%E5%88%9D%E5%A7%8B%E6%B8%B2%E6%9F%93%E5%8E%9F%E7%90%86/"><div class="card-body"> <span class="timeago small" > Nov 25, 2021 <i class="unloaded">2021-11-25T14:29:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>手写Vue2.0源码（三）-初始渲染原理</h3><div class="text-muted small"><p> 1.组件挂载入口 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 // src/init.js import { mountComponent } from './lifecycle'; Vue.prototype.$mount = function (el) { const vm = this; c...</p></div></div></a></div><div class="card"> <a href="/posts/Vue%E6%B8%B2%E6%9F%93%E6%9B%B4%E6%96%B0%E5%8E%9F%E7%90%86/"><div class="card-body"> <span class="timeago small" > Nov 27, 2021 <i class="unloaded">2021-11-27T15:03:00+08:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>手写Vue2.0源码（四）-渲染更新原理</h3><div class="text-muted small"><p> 正文 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // Vue实例化 let vm = new Vue({ el: '#app', data() { return { a: 123 }; }, ...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/vue%E5%93%8D%E5%BA%94%E5%BC%8F%E5%8E%9F%E7%90%86/" class="btn btn-outline-primary" prompt="Older"><p>手写Vue2.0源码（一）-响应式数据原理</p></a> <a href="/posts/%E5%87%BD%E6%95%B0%E9%87%8D%E8%BD%BD/" class="btn btn-outline-primary" prompt="Newer"><p>函数重载</p></a></div></div></div></div><script type="text/javascript" src="https://cdn.jsdelivr.net/npm/lozad/dist/lozad.min.js"></script> <script type="text/javascript"> const imgs = document.querySelectorAll('.post-content img'); const observer = lozad(imgs); observer.observe(); </script><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/username">hanxitao</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/css/">css</a> <a class="post-tag" href="/tags/everydaylearn/">EverydayLearn</a> <a class="post-tag" href="/tags/js%E7%9B%B8%E5%85%B3/">js相关</a> <a class="post-tag" href="/tags/vue%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/">Vue源码分析</a> <a class="post-tag" href="/tags/leetcode/">LeetCode</a> <a class="post-tag" href="/tags/%E6%89%8B%E5%86%99/">手写</a> <a class="post-tag" href="/tags/javascript/">javascript</a> <a class="post-tag" href="/tags/vue/">Vue</a> <a class="post-tag" href="/tags/jekyll/">jekyll</a> <a class="post-tag" href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/">数据结构</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://hanxitao.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
